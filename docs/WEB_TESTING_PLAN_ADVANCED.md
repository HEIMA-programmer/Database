# 高级测试场景

> 版本: 2.0
> 关联主文件: [WEB_TESTING_PLAN.md](WEB_TESTING_PLAN.md)
> 主线角色: Alice Fan

---

## 目录

1. [多用户协同测试](#1-多用户协同测试)
2. [调货成本变化追踪测试](#2-调货成本变化追踪测试)
3. [数据一致性验证测试](#3-数据一致性验证测试)
4. [边界条件与异常测试](#4-边界条件与异常测试)
5. [完整业务流程测试](#5-完整业务流程测试)

---

## 1. 多用户协同测试

### 1.1 库存并发预留测试

**场景：** Alice和Bob同时购买同一件库存

**测试用例 1.1.1: 并发下单竞争**

| 时间线 | Alice操作 | Bob操作 | 库存状态 |
|--------|---------|--------|---------|
| T1 | 浏览长沙店Abbey Road New | 浏览长沙店Abbey Road New | Available |
| T2 | 加入购物车(StockID=1) | 加入购物车(StockID=1) | Available |
| T3 | 进入Checkout | 进入Checkout | Available |
| T4 | **点击Pay Now** | - | **Reserved** |
| T5 | 订单创建成功 | 点击Pay Now | Reserved |
| T6 | - | **显示错误：商品不再可用** | Reserved |

**验证要点：**
- 第一个提交的用户成功预留
- 第二个用户收到明确错误提示
- 库存不会被重复预留

**操作步骤：**
1. 打开两个浏览器窗口（或隐身模式）
2. 分别登录Alice和Bob
3. 同时浏览同一商品
4. 同时加入购物车
5. 快速交替点击下单
6. 验证只有一方成功

### 1.2 调拨与销售并发测试

**场景：** Admin批准调货的同时，库存被客户购买

**测试用例 1.2.1: 调货与销售竞争**

| 时间线 | Admin操作 | Alice操作 | 库存状态 |
|--------|---------|---------|---------|
| T1 | 查看调货申请(Opera New) | 浏览仓库Opera New | Available |
| T2 | 准备批准 | 加入购物车 | Available |
| T3 | - | **点击Place Order** | **Reserved** |
| T4 | 点击Approve | - | Reserved |
| T5 | **显示错误：库存不足** | 订单创建成功 | Reserved |

**验证要点：**
- 系统检查实时库存状态
- 已被预留的库存不会被调拨

### 1.3 订单完成与积分同步测试

**场景：** 员工完成订单，客户积分实时更新

**测试用例 1.3.1: Alice积分实时更新**

| 步骤 | 角色 | 操作 | Alice积分 |
|------|------|------|---------|
| 1 | Alice | 查看Profile | 1500 |
| 2 | Alice | 下单¥100商品(折后¥95) | 1500 |
| 3 | Alice | 支付订单 | 1500 (无变化) |
| 4 | staff | 发货 | 1500 (无变化) |
| 5 | staff | **点击Complete** | **1595** |
| 6 | Alice | 刷新Profile | 显示1595 |

**验证要点：**
- 积分在订单Complete时通过触发器自动增加
- 客户无需重新登录即可看到更新

### 1.4 调拨流程多角色协同测试

**场景：** 完整调货流程涉及4个角色

**测试用例 1.4.1: 调货全流程协同**

| 步骤 | 角色 | 操作 | 数据变化 |
|------|------|------|---------|
| 1 | manager_cs | 提交调货申请: Rumours New ×2 | ManagerRequest(Pending) |
| 2 | admin | 批准申请，选择仓库为源 | Request=Approved, 创建Transfer(Pending) |
| 3 | staff_wh | 确认发货 | Transfer=InTransit, Stock=InTransit |
| 4 | staff_cs | 确认收货 | Transfer=Completed, Stock.ShopID=1 |
| 5 | manager_cs | 刷新Dashboard | 新增2件Rumours New |

---

## 2. 调货成本变化追踪测试

> 这是测试Dashboard实时更新能力的关键场景
>
> **重要更新：** 成本计算现在使用"Total Cost"（历史总成本），统计所有库存（包含已售出）的采购成本。调货时成本从源店转移到目标店。

### 2.1 初始状态记录

**各店Total Cost基准值（包含已售库存）：**

| 店铺 | 初始成本(约) | 库存件数（含已售） |
|------|-------------|-------------------|
| 长沙店 | ¥415 | 13件（11件可用+2件已售） |
| 上海店 | ¥615 | 16件（13件可用+3件已售） |
| 仓库 | ¥900 | 28件（25件可用+3件已售） |

### 2.2 调货成本追踪测试

**测试用例 2.2.1: 完整成本追踪**

**步骤1: 记录初始值**

| 操作 | 验证 |
|------|------|
| manager_cs登录 | 进入长沙店Dashboard |
| 记录Total Cost小框 | 值A (如¥415) |
| 记录Revenue Breakdown的Total Cost | 值A' (应与A相同) |
| manager_wh登录 | 进入仓库Dashboard |
| 记录Total Cost小框 | 值B (如¥900) |

**步骤2: 执行调货**

| 角色 | 操作 | 预期 |
|------|------|------|
| manager_cs | 提交调货: Opera New ×2 | 申请创建 |
| admin | 批准，选仓库为源 | Transfer创建 |
| staff_wh | 确认发货 | 状态InTransit |
| staff_cs | **确认收货** | **关键步骤** |

**步骤3: 验证成本变化**

| 验证项 | 操作 | 预期结果 |
|--------|------|---------|
| 长沙店Dashboard刷新 | manager_cs | Total Cost = A + 2×36 = A + 72 |
| 仓库Dashboard刷新 | manager_wh | Total Cost = B - 2×36 = B - 72 |
| Revenue Breakdown更新 | 两边查看 | Total Cost行同步更新 |

### 2.3 成本计算规则验证

**调货商品成本来源：**

| SourceType | 成本来源字段 |
|------------|-------------|
| Supplier（供应商采购） | SupplierOrderLine.UnitCost |
| Buyback（回购入库） | BuybackOrderLine.UnitPrice |

**测试用例 2.3.1: Supplier来源成本验证**

| 步骤 | 操作 | 预期 |
|------|------|------|
| 1 | 查看仓库Opera New的SourceType | Supplier |
| 2 | 查看SupplierOrderLine.UnitCost | ¥36 (BaseUnitCost×1.0) |
| 3 | 调货1件到长沙店 | 调货完成 |
| 4 | 验证长沙店Total Cost增加 | +¥36 |

**测试用例 2.3.2: Buyback来源成本验证**

| 步骤 | 操作 | 预期 |
|------|------|------|
| 1 | 查看长沙店Opera VG+的SourceType | Buyback（Bob回购） |
| 2 | 查看BuybackOrderLine.UnitPrice | ¥12 |
| 3 | 如需调货该库存到上海店 | 调货完成 |
| 4 | 验证上海店Total Cost增加 | +¥12 |

### 2.4 销售后成本变化验证

> **重要更新：** 销售完成后Total Cost**不会减少**，因为已售库存的历史成本仍计入统计。

**测试用例 2.4.1: 销售不改变Total Cost**

| 步骤 | 操作 | 预期 |
|------|------|------|
| 1 | 记录长沙店Total Cost | 值X |
| 2 | POS销售1件Abbey Road New | 销售完成 |
| 3 | 刷新Dashboard | Total Cost = X（**保持不变**） |
| 4 | 验证库存件数显示 | 件数不变（items incl. sold） |

---

## 3. 数据一致性验证测试

### 3.1 价格一致性测试

**规则：** 同一Release + 同一Condition的所有库存必须单价相同

**测试用例 3.1.1: 采购时价格同步**

| 步骤 | 操作 | 验证 |
|------|------|------|
| 1 | 确认长沙店Abbey Road New价格 | ¥56.00 |
| 2 | 创建采购: Abbey Road New, 售价¥60 | 订单创建 |
| 3 | 接收订单 | 生成新库存 |
| 4 | **验证长沙店现有Abbey Road New** | **全部变为¥60** |
| 5 | **验证其他店铺Abbey Road New** | **全部变为¥60** |

**测试用例 3.1.2: 回购时价格检查**

| 步骤 | 操作 | 验证 |
|------|------|------|
| 1 | 确认现有Opera VG+价格 | ¥40.32 |
| 2 | 回购Opera VG+，输入转售价¥50 | 提交回购 |
| 3 | **验证新库存价格** | **应为¥40.32（使用现有价格）** |

### 3.2 库存状态一致性测试

**状态转换规则：**

| 初始状态 | 操作 | 目标状态 | 允许 |
|---------|------|---------|------|
| Available | 客户下单 | Reserved | ✅ |
| Reserved | 订单取消 | Available | ✅ |
| Reserved | 订单完成 | Sold | ✅ |
| Available | 发起调拨 | InTransit | ✅ |
| InTransit | 完成调拨 | Available | ✅ |
| Sold | 任何操作 | - | ❌ |
| Reserved | 发起调拨 | - | ❌ |

**测试用例 3.2.1: 已预留库存不能调拨**

| 步骤 | 操作 | 预期 |
|------|------|------|
| 1 | Alice下单预留某库存 | Status=Reserved |
| 2 | 尝试对该库存发起调拨 | 触发器报错 |
| 3 | 验证错误信息 | "Can only transfer available stock" |

### 3.3 订单金额一致性测试

**计算公式：** 订单金额 = 商品小计 × (1-折扣率) + 运费

**测试用例 3.3.1: VIP订单金额验证**

| 项目 | 值 |
|------|-----|
| 商品小计 | ¥100.00 |
| VIP折扣(5%) | -¥5.00 |
| 运费(Shipping) | +¥15.00 |
| **总计** | **¥110.00** |

**测试用例 3.3.2: Gold订单金额验证**

| 项目 | 值 |
|------|-----|
| 商品小计 | ¥100.00 |
| Gold折扣(10%) | -¥10.00 |
| 运费(Pickup) | ¥0.00 |
| **总计** | **¥90.00** |

### 3.4 积分计算一致性测试

**测试用例 3.4.1: 购物积分计算**

| 客户 | 订单金额 | 是否生日月 | 预期积分 |
|------|---------|-----------|---------|
| Alice(5月生日) | ¥100 | 否(当前12月) | +100 |
| Diana(12月生日) | ¥100 | 是 | +120 (100×1.2) |
| Bob(12月生日) | ¥100 | 是 | +120 (100×1.2) |

**测试用例 3.4.2: 回购积分计算**

| 客户 | 回购金额 | 预期积分 |
|------|---------|---------|
| Alice | ¥100 | +50 (100×0.5) |
| Walk-in | ¥100 | 无积分 |

### 3.5 会员等级自动升级测试

**测试用例 3.5.1: 等级升级验证**

| 客户 | 当前积分 | 当前等级 | 订单金额 | 新积分 | 新等级 |
|------|---------|---------|---------|-------|-------|
| Charlie | 150 | Standard | ¥900 | 1050 | **VIP** |
| Alice | 1500 | VIP | ¥3600 | 5100 | **Gold** |
| Edward | 450 | Standard | ¥100 | 550 | Standard |

---

## 4. 边界条件与异常测试

### 4.1 权限边界测试

| 测试场景 | 操作 | 预期结果 |
|---------|------|---------|
| Customer访问Staff页面 | 访问 /staff/pos.php | 重定向到登录 |
| Staff访问Admin页面 | staff访问 /admin/requests.php | 拒绝访问 |
| 仓库Staff访问POS | staff_wh访问 /staff/pos.php | 显示错误并重定向 |
| 仓库Staff访问Buyback | staff_wh访问 /staff/buyback.php | 显示"仅门店可用" |

### 4.2 库存边界测试

| 测试场景 | 操作 | 预期结果 |
|---------|------|---------|
| 购买最后一件 | 购买某专辑仅剩的1件 | 购买成功，目录显示"Out of Stock" |
| 商品被他人买走 | 结账时商品已被预留 | 显示"商品不再可用" |
| 调拨超过可用数量 | 申请10件，实际3件 | Admin批准时显示错误 |

### 4.3 输入验证测试

| 测试场景 | 输入 | 预期结果 |
|---------|------|---------|
| 回购负数价格 | 单价=-10 | 表单验证失败 |
| 采购零数量 | 数量=0 | 表单验证失败 |
| 空白地址配送 | Shipping但地址空 | 显示"请输入地址" |
| 重复邮箱注册 | 已存在邮箱 | 显示"邮箱已存在" |
| 密码不匹配 | 确认密码不同 | 显示"密码不匹配" |

### 4.4 状态流转异常测试

| 测试场景 | 操作 | 预期结果 |
|---------|------|---------|
| 取消已完成订单 | 对Completed订单点取消 | 操作不可用 |
| 修改已发货订单 | 修改Shipped订单商品 | 触发器阻止 |
| 调拨到同一店铺 | FromShop = ToShop | 触发器阻止 |
| 已售库存再售 | 对Sold库存下单 | 系统过滤，不可选 |

### 4.5 并发超时测试

| 测试场景 | 操作 | 预期结果 |
|---------|------|---------|
| 30分钟未支付 | 创建订单后等待 | 自动取消，释放库存 |
| 支付页面刷新 | 订单已取消后刷新 | 显示"订单已取消" |

---

## 5. 完整业务流程测试

### 5.1 Alice完整购物体验

**场景：** Alice从浏览到收货的完整流程

| 步骤 | 操作 | 验证点 |
|------|------|--------|
| 1 | 登录alice@test.com | Session建立 |
| 2 | 查看Profile | VIP/1500积分/5%折扣 |
| 3 | 进入Catalog，选择长沙店 | 显示长沙店库存 |
| 4 | 搜索Beatles | 只显示Abbey Road |
| 5 | 进入Abbey Road详情 | 显示成色和价格 |
| 6 | 选择Mint(¥53.20)加入购物车 | 购物车+1 |
| 7 | 进入Cart | 显示1件，¥53.20 |
| 8 | 进入Checkout | 显示VIP折扣 |
| 9 | 选择Pickup | 运费¥0 |
| 10 | 验证总计 | ¥50.54 |
| 11 | 支付 | 订单Paid |
| 12 | staff_cs处理自提 | Mark as Collected |
| 13 | Alice刷新Profile | 积分+50=1550 |

### 5.2 调货完整流程

**场景：** 从申请到收货的完整调货流程

| 步骤 | 角色 | 操作 | 验证点 |
|------|------|------|--------|
| 1 | manager_cs | 记录Dashboard Inventory Cost | 初始值 |
| 2 | manager_cs | 提交调货申请(Opera×2) | 申请Pending |
| 3 | admin | 批准申请，选仓库 | Transfer创建 |
| 4 | staff_wh | 确认发货 | Status=InTransit |
| 5 | staff_cs | 确认收货 | Status=Completed |
| 6 | manager_cs | 刷新Dashboard | 成本增加 |
| 7 | manager_wh | 刷新Dashboard | 成本减少 |

### 5.3 采购完整流程

**场景：** 从创建到入库的完整采购流程

| 步骤 | 操作 | 验证点 |
|------|------|--------|
| 1 | admin创建采购订单 | 5件Abbey Road New |
| 2 | 验证成本计算 | ¥35×1.0=¥35/件 |
| 3 | 验证建议售价 | ¥35×1.6=¥56 |
| 4 | 接收订单 | 状态Received |
| 5 | 验证库存生成 | 新增5件Available |
| 6 | 验证价格一致性 | 所有Abbey Road New价格同步 |

### 5.4 回购完整流程

**场景：** Alice参与回购的完整流程

| 步骤 | 角色 | 操作 | 验证点 |
|------|------|------|--------|
| 1 | staff_sh | 选择客户Alice | CustomerID=1 |
| 2 | staff_sh | 选择Thriller VG, 2件, ¥10/件 | 表单填写 |
| 3 | staff_sh | 提交回购 | 成功消息 |
| 4 | 验证 | BuybackOrder创建 | TotalPayment=¥20 |
| 5 | 验证 | StockItem生成 | 2件Thriller VG |
| 6 | 验证 | Alice积分增加 | +10积分 |

---

## 附录：高级测试检查清单

### A. 多用户协同检查

- [ ] 并发下单只有一方成功
- [ ] 已预留库存不可调拨
- [ ] 积分在订单完成时更新
- [ ] 调货流程各角色协同正确

### B. 成本追踪检查

- [ ] 调货后源店Total Cost减少
- [ ] 调货后目标店Total Cost增加
- [ ] 销售后Total Cost**保持不变**（已售库存成本仍计入）
- [ ] Dashboard Total Cost实时更新正确（调货转移）
- [ ] Revenue Breakdown Total Cost行显示正确

### C. 数据一致性检查

- [ ] 采购时价格同步更新
- [ ] 回购时使用现有价格
- [ ] 库存状态流转正确
- [ ] 订单金额计算正确
- [ ] 积分计算正确
- [ ] 等级自动升级

### D. 边界条件检查

- [ ] 权限边界拦截正确
- [ ] 库存边界处理正确
- [ ] 输入验证生效
- [ ] 状态流转异常阻止
- [ ] 超时自动取消生效

### E. 完整流程检查

- [ ] 客户购物全流程通畅
- [ ] 调货全流程通畅
- [ ] 采购全流程通畅
- [ ] 回购全流程通畅

---

**文档结束**

> 本高级测试方案覆盖了系统的复杂场景、并发处理、数据一致性和边界条件。建议在完成基础功能测试后，再执行这些高级测试用例。
